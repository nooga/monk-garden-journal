---
import Layout from '../layouts/Layout.astro';
import { getStore } from '@netlify/blobs';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const title = formData.get('title');
    const notes = formData.get('notes');
    const image = formData.get('image');
    
    // Handle image upload
    let imageUrl = null;
    if (image instanceof File && image.size > 0) {
      const imageStore = await getStore('garden-images');
      const imageKey = `${Date.now()}-${image.name}`;
      await imageStore.set(imageKey, image);
      imageUrl = `/images/${imageKey}`;
    }

    // Create journal entry
    const journalStore = await getStore('journal-entries');
    const entryKey = Date.now().toString();
    const entry = {
      title,
      notes,
      date: new Date().toISOString(),
      imageUrl
    };
    
    await journalStore.set(entryKey, JSON.stringify(entry));
    return Astro.redirect('/');
  } catch (error) {
    console.error('Error saving entry:', error);
  }
}
---

<Layout title="New Garden Journal Entry">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-green-800 mb-6">New Garden Journal Entry</h1>
    
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
          Title
        </label>
        <input
          type="text"
          id="title"
          name="title"
          required
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent"
        />
      </div>

      <div>
        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
          Notes
        </label>
        <textarea
          id="notes"
          name="notes"
          rows="4"
          required
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent"
        ></textarea>
      </div>

      <div>
        <label for="image" class="block text-sm font-medium text-gray-700 mb-1">
          Photo
        </label>
        <input
          type="file"
          id="image"
          name="image"
          accept="image/*"
          class="w-full"
        />
      </div>

      <div class="flex gap-4">
        <button
          type="submit"
          class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
        >
          Save Entry
        </button>
        <a
          href="/"
          class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
        >
          Cancel
        </a>
      </div>
    </form>
  </div>
</Layout>